version: '3'
vars:
  VERSION:
    sh: cat VERSION
  # Default variables for remote Mac tasks. Override with CLI vars.
  # e.g. task macos:build MAC_HOST=user@192.168.1.50
  MAC_HOST: '{{.MAC_HOST | default "user@remote-mac"}}'
  MAC_API_HOST: '{{.MAC_API_HOST | default "remote-mac"}}'
  MAC_API_PORT: '{{.MAC_API_PORT | default "8089"}}'

tasks:
  build-macos-app:
    desc: Copy code to Mac and build macOS .app bundle and DMG remotely
    vars:
      MAC_SRC: "~/mlcupscale_src"
    cmds:
      - |
        if [ "{{.MAC_HOST}}" = "user@remote-mac" ]; then
          echo "Error: MAC_HOST variable not set. Use 'MAC_HOST=user@host task build-macos-app'"
          exit 1
        fi
        echo "Syncing code to {{.MAC_HOST}}..."
        rsync -az --delete --exclude 'bin/' --exclude 'build/' --exclude '.git/' --exclude 'data/outputs/' --exclude 'data/uploads/' ./ {{.MAC_HOST}}:{{.MAC_SRC}}
        echo "Running build script on Mac..."
        ssh {{.MAC_HOST}} 'cd {{.MAC_SRC}}/deployments/macos && ./build-macos-app.sh'
    sources:
      - ./cmd/server/main.go
      - ./deployments/macos/Info.plist
      - ./deployments/macos/build-macos-app.sh
    generates:
      - '{{.MAC_SRC}}/../mlcupscale_build/MLCupscale.dmg'

  sync-macos:
    desc: Sync code to Mac without building
    vars:
      MAC_SRC: "~/mlcupscale_src"
    cmds:
      - |
        if [ "{{.MAC_HOST}}" = "user@remote-mac" ]; then
          echo "Error: MAC_HOST variable not set."
          exit 1
        fi
        rsync -az --delete --exclude 'bin/' --exclude 'build/' --exclude '.git/' --exclude 'data/outputs/' --exclude 'data/uploads/' ./ {{.MAC_HOST}}:{{.MAC_SRC}}

  start-macos-app:
    desc: Start the built application on the remote Mac
    cmds:
      - echo "Stopping existing instances..."
      - ssh {{.MAC_HOST}} 'pkill -f mlcupscale-bin || true'
      - echo "Starting MLCupscale.app on Mac..."
      - ssh {{.MAC_HOST}} 'open ~/mlcupscale_build/MLCupscale.app'

  stop-macos-app:
    desc: Stop the running application on the remote Mac
    cmds:
      - echo "Stopping MLCupscale on Mac..."
      - ssh {{.MAC_HOST}} 'pkill -f mlcupscale-bin || echo "No process found"'

  test-macos-health:
    desc: Test the health endpoint of the remote Mac service
    cmds:
      - echo "Checking health at http://{{.MAC_API_HOST}}:{{.MAC_API_PORT}}/api/v1/health..."
      - curl -f http://{{.MAC_API_HOST}}:{{.MAC_API_PORT}}/api/v1/health

  get-macos-logs:
    desc: Retrieve the application logs from the Mac
    cmds:
      - ssh {{.MAC_HOST}} 'tail -n 50 ~/Library/Logs/MLCupscale.log'

  test-macos-upscale:
    desc: Run a real upscale test against the Mac service with a tiny image
    cmds:
      - ./scripts/verify_upscale.sh {{.MAC_API_HOST}} {{.MAC_API_PORT}}

  verify-macos:
    desc: Build, Start, and Test the macOS deployment
    cmds:
      - task: build-macos-app
      - task: start-macos-app
      - cmd: sleep 5
      - task: test-macos-health
      - task: test-macos-upscale

  # ============================================================================
  # LINUX / LOCAL TASKS
  # ============================================================================

  build:
    desc: Build the server binary for Linux
    cmds:
      - go build -ldflags="-s -w -X upscale-service/internal/version.Version={{.VERSION}}" -o bin/upscale-server cmd/server/main.go
    sources:
      - cmd/server/main.go
      - internal/**/*.go
    generates:
      - bin/upscale-server

  run:
    desc: Build and run the server locally
    deps: [build]
    cmds:
      - ./bin/upscale-server -config config/config.yaml

  test:
    desc: Run unit tests
    cmds:
      - go test -v ./...

  download-models:
    desc: Download Real-ESRGAN models if missing
    cmds:
      - ./scripts/download-models.sh
    status:
      - test -d models
      - test -f bin/realesrgan-ncnn-vulkan
